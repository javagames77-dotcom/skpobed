<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>InSkill Online</title>
<style>
:root{--p:#0066CC;--s:#FF9933;--d:#1a1a1a;--l:#f8f9fa;--b:#e0e0e0}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:var(--l);color:var(--d)}
.header{background:#fff;border-bottom:3px solid var(--p);padding:1rem 2rem;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.header-content{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:.75rem;font-size:1.5rem;font-weight:700;color:var(--p);text-decoration:none}
.logo-icon{width:40px;height:40px;background:var(--p);border-radius:8px;display:flex;align-items:center;justify-content:center}
.logo-bars{display:flex;gap:3px;align-items:flex-end}
.logo-bar{width:6px;background:#fff;border-radius:2px}
.logo-bar:nth-child(1){height:12px}
.logo-bar:nth-child(2){height:18px;background:var(--s)}
.logo-bar:nth-child(3){height:24px;background:var(--s)}
.btn-logout{padding:.5rem 1rem;background:#fff;border:1px solid var(--b);border-radius:6px;cursor:pointer;font-size:.9rem}
.container{max-width:1400px;margin:2rem auto;padding:0 2rem}
.tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;border-bottom:2px solid var(--b)}
.tab{padding:1rem 2rem;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:1rem;font-weight:600;color:#666}
.tab.active{color:var(--p);border-bottom-color:var(--p)}
.tab-content{display:none}
.tab-content.active{display:block}
.page-header{background:#fff;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
.page-title{font-size:1.75rem;font-weight:700;color:var(--p)}
.filters{background:#fff;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05);display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end}
.filter-group{flex:1;min-width:200px}
.filter-label{display:block;margin-bottom:.5rem;font-size:.85rem;font-weight:600;color:#555;text-transform:uppercase}
.filter-input,.filter-select{width:100%;padding:.75rem;border:2px solid var(--b);border-radius:8px;font-size:1rem}
.btn-add{padding:.75rem 1.5rem;background:var(--s);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;display:flex;align-items:center;gap:.5rem;white-space:nowrap}
.table-container{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);overflow:hidden}
.table{width:100%;border-collapse:collapse}
.table thead{background:linear-gradient(135deg,var(--p),#0052a3);color:#fff}
.table th{padding:1rem;text-align:left;font-weight:600;text-transform:uppercase;font-size:.85rem}
.table td{padding:1rem;border-bottom:1px solid var(--b)}
.child-photo{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid var(--b)}
.group-badge{display:inline-block;padding:.35rem .75rem;background:#e3f2fd;color:var(--p);border-radius:20px;font-size:.85rem;font-weight:500}
.table-actions{display:flex;gap:.5rem}
.btn-icon{width:36px;height:36px;border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.btn-edit{background:#e3f2fd;color:var(--p)}
.btn-delete{background:#ffebee;color:#dc3545}
.loading{text-align:center;padding:3rem;color:var(--p)}
.empty-state{text-align:center;padding:4rem 2rem;color:#999}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:1rem}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{padding:1.5rem;border-bottom:2px solid var(--b);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:1.5rem;font-weight:700;color:var(--p)}
.modal-close{width:32px;height:32px;border:none;background:var(--l);border-radius:50%;cursor:pointer;font-size:1.2rem}
.modal-body{padding:1.5rem}
.form-group{margin-bottom:1.25rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:600;color:#555;font-size:.9rem}
.form-input,.form-select{width:100%;padding:.75rem;border:2px solid var(--b);border-radius:8px;font-size:1rem}
.date-inputs{display:flex;gap:.75rem}
.date-inputs .form-group{flex:1;margin-bottom:0}
.modal-footer{padding:1.5rem;border-top:2px solid var(--b);display:flex;gap:1rem;justify-content:flex-end}
.btn{padding:.75rem 1.5rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem}
.btn-cancel{background:var(--l);color:var(--d)}
.btn-save{background:var(--s);color:#fff}
@media (max-width:768px){
.container{padding:0 1rem}
.tabs{overflow-x:auto}
.page-header{flex-direction:column;gap:1rem;align-items:flex-start}
.filters{flex-direction:column}
.filter-group{width:100%}
.btn-add{width:100%;justify-content:center}
.table thead{display:none}
.table,.table tbody,.table tr,.table td{display:block}
.table tr{background:#fff;margin-bottom:1rem;border-radius:12px;padding:1rem}
.table td{border:none;padding:.5rem 0;display:flex;justify-content:space-between}
.table td:before{content:attr(data-label);font-weight:600;color:#666;font-size:.85rem}
.table td:first-child{justify-content:center;padding-bottom:1rem;border-bottom:1px solid var(--b)}
.table td:first-child:before{display:none}
.date-inputs{flex-direction:column}
}
</style>
</head>
<body>

<header class="header">
<div class="header-content">
<a href="/" class="logo">
<div class="logo-icon"><div class="logo-bars"><div class="logo-bar"></div><div class="logo-bar"></div><div class="logo-bar"></div></div></div>
<span>InSkill<span style="color:var(--s)">.online</span></span>
</a>
<div style="display:flex;align-items:center;gap:1rem">
<span id="userName">‚Äî</span>
<button class="btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
</div>
</div>
</header>

<div class="container">
<div class="tabs">
<button class="tab active" onclick="switchTab('children')">üë∂ –î–µ—Ç–∏</button>
<button class="tab" onclick="switchTab('groups')">üë• –ì—Ä—É–ø–ø—ã</button>
</div>

<div class="tab-content active" id="tab-children">
<div class="page-header">
<h1 class="page-title">–î–µ—Ç–∏</h1>
<button class="btn-add" onclick="addChild()"><span>‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å</span></button>
</div>
<div class="filters">
<div class="filter-group">
<label class="filter-label">–ü–æ–∏—Å–∫</label>
<input type="text" class="filter-input" id="searchInput" placeholder="–ò–º—è...">
</div>
<div class="filter-group">
<label class="filter-label">–ì—Ä—É–ø–ø–∞</label>
<select class="filter-select" id="groupFilter"><option value="">–í—Å–µ</option></select>
</div>
</div>
<div class="table-container">
<div id="loadingChildren" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<div id="emptyChildren" class="empty-state" style="display:none"><h3>–ù–µ—Ç –¥–µ—Ç–µ–π</h3></div>
<table class="table" id="childrenTable" style="display:none">
<thead><tr><th>–§–æ—Ç–æ</th><th>–§–ò–û</th><th>–ì—Ä—É–ø–ø–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="childrenTableBody"></tbody>
</table>
</div>
</div>

<div class="tab-content" id="tab-groups">
<div class="page-header">
<h1 class="page-title">–ì—Ä—É–ø–ø—ã</h1>
<button class="btn-add" onclick="addGroup()"><span>‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å</span></button>
</div>
<div class="table-container">
<div id="loadingGroups" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<div id="emptyGroups" class="empty-state" style="display:none"><h3>–ù–µ—Ç –≥—Ä—É–ø–ø</h3></div>
<table class="table" id="groupsTable" style="display:none">
<thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="groupsTableBody"></tbody>
</table>
</div>
</div>
</div>

<div class="modal" id="childModal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title" id="childModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞</h2>
<button class="modal-close" onclick="closeChildModal()">‚úï</button>
</div>
<div class="modal-body">
<form id="childForm" onsubmit="saveChild(event)">
<input type="hidden" id="childId">
<div class="form-group">
<label class="form-label">–ò–º—è *</label>
<input type="text" class="form-input" id="childFirstName" required>
</div>
<div class="form-group">
<label class="form-label">–§–∞–º–∏–ª–∏—è *</label>
<input type="text" class="form-input" id="childLastName" required>
</div>
<div class="form-group">
<label class="form-label">–ì—Ä—É–ø–ø–∞ *</label>
<select class="form-select" id="childGroupId"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option></select>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-cancel" onclick="closeChildModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="btn btn-save" onclick="document.getElementById('childForm').requestSubmit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<div class="modal" id="groupModal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title" id="groupModalTitle">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</h2>
<button class="modal-close" onclick="closeGroupModal()">‚úï</button>
</div>
<div class="modal-body">
<form id="groupForm" onsubmit="saveGroup(event)">
<input type="hidden" id="groupId">
<div class="form-group">
<label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
<input type="text" class="form-input" id="groupName" required>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-cancel" onclick="closeGroupModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="btn btn-save" onclick="document.getElementById('groupForm').requestSubmit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<script>
const API='https://primary-production-4b93e.up.railway.app/webhook-test/api';
let token=localStorage.getItem('token');
let children=[],groups=[],filtered=[];
if(!token)window.location.href='/';

function loadUserInfo(){
    const u=JSON.parse(localStorage.getItem('user')||'{}');
    document.getElementById('userName').textContent=u.first_name?`${u.first_name} ${u.last_name||''}`.trim():u.email||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
}

function switchTab(t){
    document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(`tab-${t}`).classList.add('active');
    if(t==='groups' && groups.length===0) loadGroups();
}

function updateGroupFilter(){
    const s=document.getElementById('groupFilter'), c=document.getElementById('childGroupId');
    s.innerHTML='<option value="">–í—Å–µ</option>';
    c.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>';
    groups.forEach(g=>{
        const o1=document.createElement('option'); o1.value=g.id; o1.textContent=g.name; s.appendChild(o1);
        const o2=document.createElement('option'); o2.value=g.id; o2.textContent=g.name; c.appendChild(o2);
    });
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥ —Ç–µ–∫—É—â–∏–π webhook ---
async function loadGroups(){
    try{
        document.getElementById('loadingGroups').style.display='block';
        document.getElementById('emptyGroups').style.display='none';
        document.getElementById('groupsTable').style.display='none';

        const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'groups',action:'list'})});
        let d=await r.json();
        groups = Array.isArray(d)?d.map(g=>({id:g.id,name:g.name})):[];

        document.getElementById('loadingGroups').style.display='none';
        if(groups.length===0) document.getElementById('emptyGroups').style.display='block';
        else {document.getElementById('groupsTable').style.display='table'; renderGroupsTable();}
        updateGroupFilter();
    }catch(e){console.error(e); document.getElementById('loadingGroups').textContent='–û—à–∏–±–∫–∞';}
}

async function loadChildren(){
    try{
        document.getElementById('loadingChildren').style.display='block';
        document.getElementById('emptyChildren').style.display='none';
        document.getElementById('childrenTable').style.display='none';

        const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'children',action:'list'})});
        let d=await r.json();
        children = Array.isArray(d)?d.map(c=>({
            id:c.id,
            first_name:c.name,
            last_name:'',
            group_id:null,
            group_name:c.club_name || '–ë–µ–∑ –≥—Ä—É–ø–ø—ã',
            birth_date:null,
            photo_url:''
        })):[];

        filtered = children;
        document.getElementById('loadingChildren').style.display='none';
        if(children.length===0) document.getElementById('emptyChildren').style.display='block';
        else {document.getElementById('childrenTable').style.display='table'; renderChildrenTable();}
    }catch(e){console.error(e); document.getElementById('loadingChildren').textContent='–û—à–∏–±–∫–∞';}
}

function renderGroupsTable(){
    const t=document.getElementById('groupsTableBody'); t.innerHTML='';
    groups.forEach(g=>{
        const r=document.createElement('tr');
        r.innerHTML=`<td data-label="–ù–∞–∑–≤–∞–Ω–∏–µ">${g.name}</td><td data-label="–î–µ–π—Å—Ç–≤–∏—è"><div class="table-actions"><button class="btn-icon btn-edit" onclick="editGroup(${g.id})">‚úèÔ∏è</button><button class="btn-icon btn-delete" onclick="deleteGroup(${g.id})">üóëÔ∏è</button></div></td>`;
        t.appendChild(r);
    });
}

function renderChildrenTable(){
    const t=document.getElementById('childrenTableBody'); t.innerHTML='';
    filtered.forEach(c=>{
        const r=document.createElement('tr');
        r.innerHTML=`<td data-label="–§–æ—Ç–æ"><img src="${c.photo_url||'https://via.placeholder.com/50'}" class="child-photo"></td><td data-label="–§–ò–û">${c.first_name} ${c.last_name}</td><td data-label="–ì—Ä—É–ø–ø–∞"><span class="group-badge">${c.group_name}</span></td><td data-label="–î–µ–π—Å—Ç–≤–∏—è"><div class="table-actions"><button class="btn-icon btn-edit" onclick="editChild(${c.id})">‚úèÔ∏è</button><button class="btn-icon btn-delete" onclick="deleteChild(${c.id})">üóëÔ∏è</button></div></td>`;
        t.appendChild(r);
    });
}

// --- –§–∏–ª—å—Ç—Ä –¥–µ—Ç–µ–π ---
document.getElementById('searchInput').addEventListener('input', filterChildren);
document.getElementById('groupFilter').addEventListener('change', filterChildren);
function filterChildren(){
    const s=document.getElementById('searchInput').value.toLowerCase();
    const g=document.getElementById('groupFilter').value;
    filtered = children.filter(c=>{
        const n=c.first_name.toLowerCase().includes(s);
        const gr=!g || c.group_id==g;
        return n && gr;
    });
    renderChildrenTable();
}

// --- –û—Å—Ç–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –º–æ–¥–∞–ª—å–Ω—ã–µ) ---
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π JS, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –µ–≥–æ –∑–¥–µ—Å—å

function logout(){
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href='/';
}

loadUserInfo();
loadChildren();
loadGroups();
</script>
</body>
</html>
