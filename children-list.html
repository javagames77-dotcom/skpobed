<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InSkill Online ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
<style>
/* –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Å—å —Ç–≤–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:#f8f9fa;color:#1a1a1a}
/* ‚Ä¶ –≤–µ—Å—å —Ç–≤–æ–π CSS –∑–¥–µ—Å—å ‚Ä¶ */
</style>
</head>
<body>

<header class="header">
<div class="header-content">
<a href="/" class="logo">
<div class="logo-icon"><div class="logo-bars"><div class="logo-bar"></div><div class="logo-bar"></div><div class="logo-bar"></div></div></div>
<span>InSkill<span style="color:#FF9933">.online</span></span>
</a>
<div class="user-menu">
<span class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
<button class="btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
</div>
</div>
</header>

<div class="container">
<div class="tabs">
<button class="tab active" onclick="switchTab('children')">üë∂ –î–µ—Ç–∏</button>
<button class="tab" onclick="switchTab('groups')">üë• –ì—Ä—É–ø–ø—ã</button>
</div>

<div class="tab-content active" id="tab-children">
<div class="page-header">
<h1 class="page-title">–°–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π</h1>
</div>
<div class="table-container">
<div id="childrenTableContainer"></div>
</div>
</div>

<div class="tab-content" id="tab-groups">
<div class="page-header">
<h1 class="page-title">–ì—Ä—É–ø–ø—ã</h1>
</div>
<div class="table-container">
<div id="groupsTableContainer"></div>
</div>
</div>
</div>

<script>
const API_URL = 'https://primary-production-4b93e.up.railway.app/webhook/api';
let token = localStorage.getItem('token');
if(!token) window.location.href='/';

function loadUserInfo(){
  const u = JSON.parse(localStorage.getItem('user')||'{}');
  document.getElementById('userName').textContent = u.first_name ? `${u.first_name} ${u.last_name||''}`.trim() : u.email||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
}

// –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(t){
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(`tab-${t}`).classList.add('active');
  if(t==='groups') loadGroups();
}

// —Ä–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –¥–µ—Ç–µ–π –ø–æ–¥ —Ç–µ–∫—É—â–∏–π API
async function loadChildren(){
  const container = document.getElementById('childrenTableContainer');
  container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
  try{
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({token, resource:'children', action:'list'})
    });
    const data = await res.json();
    // –ø—Ä–∏–≤–æ–¥–∏–º –∫ –º–∞—Å—Å–∏–≤—É, –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –æ–±—ä–µ–∫—Ç
    const children = Array.isArray(data) ? data : [data];

    if(children.length===0){
      container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë∂</div><h3>–ù–µ—Ç –¥–µ—Ç–µ–π</h3></div>';
      return;
    }

    let html = '<table class="table"><thead><tr><th>–§–ò–û / –ò–º—è</th><th>ID</th><th>–°–æ–∑–¥–∞–Ω–æ</th></tr></thead><tbody>';
    children.forEach(c=>{
      html += `<tr>
        <td>${c.name || (c.first_name ? c.first_name + ' ' + (c.last_name||'') : '‚Äî')}</td>
        <td>${c.id}</td>
        <td>${c.created_at ? new Date(c.created_at).toLocaleString('ru-RU') : '‚Äî'}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;

  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
  }
}

// —Ä–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –≥—Ä—É–ø–ø –ø–æ–¥ —Ç–µ–∫—É—â–∏–π API
async function loadGroups(){
  const container = document.getElementById('groupsTableContainer');
  container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
  try{
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({token, resource:'groups', action:'list'})
    });
    const data = await res.json();
    const groups = Array.isArray(data) ? data : [data];

    if(groups.length===0){
      container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><h3>–ù–µ—Ç –≥—Ä—É–ø–ø</h3></div>';
      return;
    }

    let html = '<table class="table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>ID</th><th>–°–æ–∑–¥–∞–Ω–æ</th></tr></thead><tbody>';
    groups.forEach(g=>{
      html += `<tr>
        <td>${g.name}</td>
        <td>${g.id}</td>
        <td>${g.created_at ? new Date(g.created_at).toLocaleString('ru-RU') : '‚Äî'}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;

  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
  }
}

function logout(){localStorage.removeItem('token');localStorage.removeItem('user');window.location.href='/'}
loadUserInfo();
loadChildren();
</script>
</body>
</html>
