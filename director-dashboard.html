<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–î–∏—Ä–µ–∫—Ç–æ—Ä –∫–ª—É–±–∞ ‚Äî InSkill Online</title>
<style>
:root{--p:#0066CC;--s:#FF9933;--d:#1a1a1a;--l:#f8f9fa;--b:#e0e0e0}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:var(--l);color:var(--d)}
.header{background:#fff;border-bottom:3px solid var(--p);padding:1rem 2rem;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.header-content{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:.75rem;font-size:1.5rem;font-weight:700;color:var(--p);text-decoration:none}
.logo-icon{width:40px;height:40px;background:var(--p);border-radius:8px;display:flex;align-items:center;justify-content:center}
.logo-bars{display:flex;gap:3px;align-items:flex-end}
.logo-bar{width:6px;background:#fff;border-radius:2px}
.logo-bar:nth-child(1){height:12px}
.logo-bar:nth-child(2){height:18px;background:var(--s)}
.logo-bar:nth-child(3){height:24px;background:var(--s)}
.badge-director{padding:.25rem .75rem;background:linear-gradient(135deg,#28a745,#1e7e34);color:#fff;border-radius:20px;font-size:.85rem;font-weight:600}
.btn-logout{padding:.5rem 1rem;background:#fff;border:1px solid var(--b);border-radius:6px;cursor:pointer}
.container{max-width:1400px;margin:2rem auto;padding:0 2rem}
.tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;border-bottom:2px solid var(--b)}
.tab{padding:1rem 2rem;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:1rem;font-weight:600;color:#666}
.tab.active{color:var(--p);border-bottom-color:var(--p)}
.tab-content{display:none}
.tab-content.active{display:block}
.page-header{background:#fff;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
.page-title{font-size:1.75rem;font-weight:700;color:var(--p)}
.btn-add{padding:.75rem 1.5rem;background:var(--s);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;display:flex;align-items:center;gap:.5rem}
.table-container{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);overflow:hidden}
.table{width:100%;border-collapse:collapse}
.table thead{background:linear-gradient(135deg,var(--p),#0052a3);color:#fff}
.table th{padding:1rem;text-align:left;font-weight:600;text-transform:uppercase;font-size:.85rem}
.table td{padding:1rem;border-bottom:1px solid var(--b)}
.table tbody tr:hover{background:#f8f9ff}
.table-actions{display:flex;gap:.5rem}
.btn-icon{width:36px;height:36px;border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.btn-edit{background:#e3f2fd;color:var(--p)}
.btn-delete{background:#ffebee;color:#dc3545}
.loading{text-align:center;padding:3rem;color:var(--p)}
.child-photo{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid var(--b)}
.group-badge{display:inline-block;padding:.35rem .75rem;background:#e3f2fd;color:var(--p);border-radius:20px;font-size:.85rem;font-weight:500}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:1rem}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{padding:1.5rem;border-bottom:2px solid var(--b);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:1.5rem;font-weight:700;color:var(--p)}
.modal-close{width:32px;height:32px;border:none;background:var(--l);border-radius:50%;cursor:pointer;font-size:1.2rem}
.modal-body{padding:1.5rem}
.form-group{margin-bottom:1.25rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:600;color:#555;font-size:.9rem}
.form-input{width:100%;padding:.75rem;border:2px solid var(--b);border-radius:8px;font-size:1rem}
.modal-footer{padding:1.5rem;border-top:2px solid var(--b);display:flex;gap:1rem;justify-content:flex-end}
.btn{padding:.75rem 1.5rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem}
.btn-cancel{background:var(--l);color:var(--d)}
.btn-save{background:var(--s);color:#fff}
</style>
</head>
<body>

<header class="header">
<div class="header-content">
<a href="/" class="logo">
<div class="logo-icon"><div class="logo-bars"><div class="logo-bar"></div><div class="logo-bar"></div><div class="logo-bar"></div></div></div>
<span>InSkill<span style="color:var(--s)">.online</span></span>
</a>
<div style="display:flex;align-items:center;gap:1rem">
<span class="badge-director">üëî –î–ò–†–ï–ö–¢–û–†</span>
<span id="userName">‚Äî</span>
<button class="btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
</div>
</div>
</header>

<div class="container">
<div class="tabs">
<button class="tab active" onclick="switchTab('clubs')">üè¢ –ú–æ–∏ –∫–ª—É–±—ã</button>
<button class="tab" onclick="switchTab('groups')">üë• –ì—Ä—É–ø–ø—ã</button>
<button class="tab" onclick="switchTab('trainers')">üë®‚Äçüè´ –¢—Ä–µ–Ω–µ—Ä—ã</button>
<button class="tab" onclick="switchTab('athletes')">üèÉ –í—Å–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã</button>
</div>

<!-- CLUBS TAB -->
<div class="tab-content active" id="tab-clubs">
<div class="page-header">
<h1 class="page-title">–ú–æ–∏ –∫–ª—É–±—ã</h1>
<button class="btn-add" onclick="addClub()"><span>‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å –∫–ª—É–±</span></button>
</div>
<div class="table-container">
<div id="loadingClubs" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<table class="table" id="clubsTable" style="display:none">
<thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ê–¥—Ä–µ—Å</th><th>–ì—Ä—É–ø–ø</th><th>–¢—Ä–µ–Ω–µ—Ä–æ–≤</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="clubsTableBody"></tbody>
</table>
</div>
</div>

<!-- GROUPS TAB -->
<div class="tab-content" id="tab-groups">
<div class="page-header">
<h1 class="page-title">–ì—Ä—É–ø–ø—ã</h1>
<button class="btn-add" onclick="addGroup()"><span>‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</span></button>
</div>
<div class="table-container">
<div id="loadingGroups" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<table class="table" id="groupsTable" style="display:none">
<thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–ª—É–±</th><th>–î–µ—Ç–µ–π</th><th>–¢—Ä–µ–Ω–µ—Ä–æ–≤</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="groupsTableBody"></tbody>
</table>
</div>
</div>

<!-- TRAINERS TAB -->
<div class="tab-content" id="tab-trainers">
<div class="page-header">
<h1 class="page-title">–¢—Ä–µ–Ω–µ—Ä—ã</h1>
<button class="btn-add" onclick="addTrainer()"><span>‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞</span></button>
</div>
<div class="table-container">
<div id="loadingTrainers" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<table class="table" id="trainersTable" style="display:none">
<thead><tr><th>–§–ò–û</th><th>Email</th><th>–ö–ª—É–±–æ–≤</th><th>–ì—Ä—É–ø–ø</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="trainersTableBody"></tbody>
</table>
</div>
</div>

<!-- ATHLETES TAB -->
<div class="tab-content" id="tab-athletes">
<div class="page-header">
<h1 class="page-title">–í—Å–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã</h1>
</div>
<div class="table-container">
<div id="loadingAthletes" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<table class="table" id="athletesTable" style="display:none">
<thead><tr><th>–§–æ—Ç–æ</th><th>–§–ò–û</th><th>–ì—Ä—É–ø–ø–∞</th><th>–ö–ª—É–±</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="athletesTableBody"></tbody>
</table>
</div>
</div>
</div>

<div class="modal" id="clubModal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title" id="clubModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–ª—É–±</h2>
<button class="modal-close" onclick="closeClubModal()">‚úï</button>
</div>
<div class="modal-body">
<form id="clubForm" onsubmit="saveClub(event)">
<input type="hidden" id="clubId">
<div class="form-group">
<label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
<input type="text" class="form-input" id="clubName" required>
</div>
<div class="form-group">
<label class="form-label">–ê–¥—Ä–µ—Å</label>
<input type="text" class="form-input" id="clubAddress">
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-cancel" onclick="closeClubModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="btn btn-save" onclick="document.getElementById('clubForm').requestSubmit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<div class="modal" id="trainerModal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title" id="trainerModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞</h2>
<button class="modal-close" onclick="closeTrainerModal()">‚úï</button>
</div>
<div class="modal-body">
<form id="trainerForm" onsubmit="saveTrainer(event)">
<input type="hidden" id="trainerId">
<div class="form-group">
<label class="form-label">Email *</label>
<input type="email" class="form-input" id="trainerEmail" required>
</div>
<div class="form-group">
<label class="form-label">–ü–∞—Ä–æ–ª—å *</label>
<input type="password" class="form-input" id="trainerPassword" required>
<small style="color:#666">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</small>
</div>
<div class="form-group">
<label class="form-label">–ò–º—è *</label>
<input type="text" class="form-input" id="trainerFirstName" required>
</div>
<div class="form-group">
<label class="form-label">–§–∞–º–∏–ª–∏—è *</label>
<input type="text" class="form-input" id="trainerLastName" required>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-cancel" onclick="closeTrainerModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="btn btn-save" onclick="document.getElementById('trainerForm').requestSubmit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<div class="modal" id="groupModal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title" id="groupModalTitle">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</h2>
<button class="modal-close" onclick="closeGroupModal()">‚úï</button>
</div>
<div class="modal-body">
<form id="groupForm" onsubmit="saveGroup(event)">
<input type="hidden" id="groupId">
<div class="form-group">
<label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
<input type="text" class="form-input" id="groupName" required>
</div>
<div class="form-group">
<label class="form-label">–ö–ª—É–± *</label>
<select class="form-input" id="groupClubId" required>
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª—É–±</option>
</select>
</div>
<div class="form-group">
<label class="form-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</label>
<div style="border:1px solid var(--b);padding:1rem;border-radius:8px">
<button type="button" class="btn-add" style="margin-bottom:1rem" onclick="addScheduleDay()"><span>‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å –¥–µ–Ω—å</span></button>
<div id="scheduleDays"></div>
</div>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-cancel" onclick="closeGroupModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="btn btn-save" onclick="document.getElementById('groupForm').requestSubmit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<script>
const API='https://primary-production-4b93e.up.railway.app/webhook/api';
let token=localStorage.getItem('token');
let user=null;
let clubs=[],trainers=[],athletes=[],groups=[],schedule=[];

if(!token){window.location.href='/';throw new Error('No auth');}

function loadUserInfo(){
user=JSON.parse(localStorage.getItem('user')||'{}');
if(user.role!=='director'){alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');window.location.href='/';return}
document.getElementById('userName').textContent=user.first_name?`${user.first_name} ${user.last_name||''}`.trim():user.email||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
}

function switchTab(t){
document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
event.target.classList.add('active');
document.getElementById(`tab-${t}`).classList.add('active');
if(t==='groups'&&groups.length===0)loadGroups();
if(t==='trainers'&&trainers.length===0)loadTrainers();
if(t==='athletes'&&athletes.length===0)loadAthletes();
}

async function loadClubs(){
try{
document.getElementById('loadingClubs').style.display='block';
document.getElementById('clubsTable').style.display='none';
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'clubs',action:'list',data:{director_id:user.id}})});
let d=await r.json();
console.log('üì¶ CLUBS API RESPONSE:', d);
console.log('üë§ USER ID:', user.id, 'ROLE:', user.role);
clubs=d.merged||d||[];
console.log('üìã CLUBS PARSED:', clubs);
document.getElementById('loadingClubs').style.display='none';
document.getElementById('clubsTable').style.display='table';
renderClubsTable();
}catch(e){console.error('‚ùå CLUBS ERROR:', e)}
}

function renderClubsTable(){
const t=document.getElementById('clubsTableBody');
t.innerHTML='';
clubs.forEach(c=>{
const r=document.createElement('tr');
r.innerHTML=`<td>${c.name}</td><td>${c.address||'‚Äî'}</td><td>${c.groups_count||0}</td><td>${c.trainers_count||0}</td><td><div class="table-actions"><button class="btn-icon btn-edit" onclick="editClub(${c.id})">‚úèÔ∏è</button></div></td>`;
t.appendChild(r);
});
}

async function loadTrainers(){
try{
document.getElementById('loadingTrainers').style.display='block';
document.getElementById('trainersTable').style.display='none';
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'users',action:'list',data:{role:'trainer'}})});
let d=await r.json();
trainers=d.merged||d||[];
document.getElementById('loadingTrainers').style.display='none';
document.getElementById('trainersTable').style.display='table';
renderTrainersTable();
}catch(e){console.error(e)}
}

function renderTrainersTable(){
const t=document.getElementById('trainersTableBody');
t.innerHTML='';
trainers.forEach(tr=>{
const r=document.createElement('tr');
r.innerHTML=`<td>${tr.first_name} ${tr.last_name}</td><td>${tr.email}</td><td>${tr.clubs_count||0}</td><td>${tr.groups_count||0}</td><td><div class="table-actions"><button class="btn-icon btn-edit" onclick="editTrainer(${tr.id})">‚úèÔ∏è</button></div></td>`;
t.appendChild(r);
});
}

async function loadAthletes(){
try{
document.getElementById('loadingAthletes').style.display='block';
document.getElementById('athletesTable').style.display='none';
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'children',action:'list',data:{director_id:user.id}})});
let d=await r.json();
athletes=d.merged||d||[];
document.getElementById('loadingAthletes').style.display='none';
document.getElementById('athletesTable').style.display='table';
renderAthletesTable();
}catch(e){console.error(e)}
}

function renderAthletesTable(){
const t=document.getElementById('athletesTableBody');
t.innerHTML='';
athletes.forEach(a=>{
const r=document.createElement('tr');
r.innerHTML=`<td><img src="${a.photo_url||'https://via.placeholder.com/50'}" class="child-photo"></td><td><a href="/athlete-profile.html?id=${a.id}" style="color:var(--p);text-decoration:none;font-weight:600">${a.first_name} ${a.last_name}</a></td><td><span class="group-badge">${a.group_name||'–ë–µ–∑ –≥—Ä—É–ø–ø—ã'}</span></td><td>${a.club_name||'‚Äî'}</td><td><div class="table-actions"><button class="btn-icon btn-edit" onclick="window.location='/athlete-profile.html?id=${a.id}'">üëÅÔ∏è</button></div></td>`;
t.appendChild(r);
});
}

function addClub(){
document.getElementById('clubModalTitle').textContent='–î–æ–±–∞–≤–∏—Ç—å –∫–ª—É–±';
document.getElementById('clubId').value='';
document.getElementById('clubName').value='';
document.getElementById('clubAddress').value='';
openClubModal();
}

function editClub(id){
const c=clubs.find(x=>x.id===id);
if(!c)return;
document.getElementById('clubModalTitle').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—É–±';
document.getElementById('clubId').value=c.id;
document.getElementById('clubName').value=c.name;
document.getElementById('clubAddress').value=c.address||'';
openClubModal();
}

async function saveClub(e){
e.preventDefault();
const id=document.getElementById('clubId').value;
const name=document.getElementById('clubName').value.trim();
const address=document.getElementById('clubAddress').value.trim();
if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}
const data={name,address,director_id:user.id};
try{
const a=id?'update':'create';
if(id)data.id=parseInt(id);
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'clubs',action:a,data})});
let res=await r.json();
const result=(res.merged&&res.merged[0])||(Array.isArray(res)?res[0]:res);
if(result&&result.id){
closeClubModal();
alert(id?'–ö–ª—É–± –æ–±–Ω–æ–≤–ª–µ–Ω!':'–ö–ª—É–± —Å–æ–∑–¥–∞–Ω!');
await loadClubs();
}else{alert('–û—à–∏–±–∫–∞: '+(result?.error||JSON.stringify(res)))}
}catch(err){console.error(err);alert('–û—à–∏–±–∫–∞: '+err.message)}
}

function addTrainer(){
document.getElementById('trainerModalTitle').textContent='–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞';
document.getElementById('trainerId').value='';
document.getElementById('trainerEmail').value='';
document.getElementById('trainerPassword').value='';
document.getElementById('trainerPassword').required=true;
document.getElementById('trainerFirstName').value='';
document.getElementById('trainerLastName').value='';
openTrainerModal();
}

function editTrainer(id){
const t=trainers.find(x=>x.id===id);
if(!t)return;
document.getElementById('trainerModalTitle').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞';
document.getElementById('trainerId').value=t.id;
document.getElementById('trainerEmail').value=t.email;
document.getElementById('trainerPassword').value='';
document.getElementById('trainerPassword').required=false;
document.getElementById('trainerFirstName').value=t.first_name;
document.getElementById('trainerLastName').value=t.last_name;
openTrainerModal();
}

async function saveTrainer(e){
e.preventDefault();
const id=document.getElementById('trainerId').value;
const email=document.getElementById('trainerEmail').value.trim();
const password=document.getElementById('trainerPassword').value;
const firstName=document.getElementById('trainerFirstName').value.trim();
const lastName=document.getElementById('trainerLastName').value.trim();
if(id){
const data={id:parseInt(id),email,first_name:firstName,last_name:lastName};
if(password)data.password=password;
try{
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'users',action:'update',data})});
let res=await r.json();
const result=(res.merged&&res.merged[0])||(Array.isArray(res)?res[0]:res);
if(result&&result.id){
closeTrainerModal();
alert('–¢—Ä–µ–Ω–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!');
await loadTrainers();
}else{alert('–û—à–∏–±–∫–∞: '+(result?.error||JSON.stringify(res)))}
}catch(err){console.error(err);alert('–û—à–∏–±–∫–∞: '+err.message)}
}else{
try{
const AUTH_API='https://primary-production-4b93e.up.railway.app/webhook/auth/register';
const r=await fetch(AUTH_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'register',email,password,role:'trainer',first_name:firstName,last_name:lastName})});
if(!r.ok)throw new Error('HTTP '+r.status);
const res=await r.json();
if(res.success||res.token){
closeTrainerModal();
alert('‚úÖ –¢—Ä–µ–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω!');
await loadTrainers();
}else{alert('‚ùå '+JSON.stringify(res))}
}catch(err){console.error(err);alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+err.message+'\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ n8n Auth API')}
}
}

function openClubModal(){
document.getElementById('clubModal').classList.add('active');
document.body.style.overflow='hidden';
}

function closeClubModal(){
document.getElementById('clubModal').classList.remove('active');
document.body.style.overflow='';
}

function openTrainerModal(){
document.getElementById('trainerModal').classList.add('active');
document.body.style.overflow='hidden';
}

function closeTrainerModal(){
document.getElementById('trainerModal').classList.remove('active');
document.body.style.overflow='';
document.getElementById('trainerPassword').required=true;
}

function logout(){
localStorage.removeItem('token');
localStorage.removeItem('user');
window.location.href='/';
}

async function loadGroups(){
try{
document.getElementById('loadingGroups').style.display='block';
document.getElementById('groupsTable').style.display='none';
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'groups',action:'list'})});
let d=await r.json();
groups=d.merged||d||[];
const sel=document.getElementById('groupClubId');
sel.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª—É–±</option>'+clubs.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
document.getElementById('loadingGroups').style.display='none';
document.getElementById('groupsTable').style.display='table';
renderGroupsTable();
}catch(e){console.error(e)}
}

function renderGroupsTable(){
const t=document.getElementById('groupsTableBody');
t.innerHTML='';
groups.forEach(g=>{
const r=document.createElement('tr');
r.innerHTML=`<td><a href="/group-profile.html?id=${g.id}" style="color:var(--p);text-decoration:none;font-weight:600">${g.name}</a></td><td>${g.club_name||'‚Äî'}</td><td>${g.children_count||0}</td><td>${g.trainers_count||0}</td><td><div class="table-actions"><button class="btn-icon btn-edit" onclick="editGroup(${g.id})">‚úèÔ∏è</button><button class="btn-icon btn-delete" onclick="deleteGroup(${g.id})">üóëÔ∏è</button></div></td>`;
t.appendChild(r);
});
}

function addGroup(){
document.getElementById('groupModalTitle').textContent='–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É';
document.getElementById('groupId').value='';
document.getElementById('groupName').value='';
document.getElementById('groupClubId').value='';
schedule=[];
renderSchedule();
openGroupModal();
}

function editGroup(id){
const g=groups.find(x=>x.id===id);
if(!g)return;
document.getElementById('groupModalTitle').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É';
document.getElementById('groupId').value=g.id;
document.getElementById('groupName').value=g.name;
document.getElementById('groupClubId').value=g.club_id;
schedule=g.schedule?(typeof g.schedule==='string'?JSON.parse(g.schedule):g.schedule):[];
renderSchedule();
openGroupModal();
}

async function deleteGroup(id){
if(!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?'))return;
try{
await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'groups',action:'delete',data:{id}})});
await loadGroups();
}catch(e){console.error(e)}
}

async function saveGroup(e){
e.preventDefault();
const id=document.getElementById('groupId').value;
const name=document.getElementById('groupName').value.trim();
const club_id=document.getElementById('groupClubId').value;
if(!name||!club_id){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');return}
const data={name,club_id:parseInt(club_id),schedule:JSON.stringify(schedule)};
try{
const a=id?'update':'create';
if(id)data.id=parseInt(id);
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'groups',action:a,data})});
let res=await r.json();
const result=(res.merged&&res.merged[0])||(Array.isArray(res)?res[0]:res);
if(result&&result.id){
closeGroupModal();
alert(id?'–ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!':'–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞!');
await loadGroups();
}else{alert('–û—à–∏–±–∫–∞: '+(result?.error||JSON.stringify(res)))}
}catch(err){console.error(err);alert('–û—à–∏–±–∫–∞: '+err.message)}
}

function addScheduleDay(){
schedule.push({day:'Monday',time_start:'10:00',time_end:'12:00'});
renderSchedule();
}

function renderSchedule(){
const d=document.getElementById('scheduleDays');
d.innerHTML=schedule.map((s,i)=>`
<div style="background:var(--l);padding:1rem;margin-bottom:0.5rem;border-radius:8px">
<div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
<select onchange="schedule[${i}].day=this.value" style="padding:0.5rem;border:1px solid var(--b);border-radius:4px">
<option ${s.day==='Monday'?'selected':''}>Monday</option>
<option ${s.day==='Tuesday'?'selected':''}>Tuesday</option>
<option ${s.day==='Wednesday'?'selected':''}>Wednesday</option>
<option ${s.day==='Thursday'?'selected':''}>Thursday</option>
<option ${s.day==='Friday'?'selected':''}>Friday</option>
<option ${s.day==='Saturday'?'selected':''}>Saturday</option>
<option ${s.day==='Sunday'?'selected':''}>Sunday</option>
</select>
<button type="button" class="btn-icon btn-delete" onclick="schedule.splice(${i},1);renderSchedule()">üóëÔ∏è</button>
</div>
<div style="display:flex;gap:1rem">
<input type="time" value="${s.time_start}" onchange="schedule[${i}].time_start=this.value" style="flex:1;padding:0.5rem;border:1px solid var(--b);border-radius:4px">
<input type="time" value="${s.time_end}" onchange="schedule[${i}].time_end=this.value" style="flex:1;padding:0.5rem;border:1px solid var(--b);border-radius:4px">
</div>
</div>`).join('');
}

function openGroupModal(){
document.getElementById('groupModal').classList.add('active');
document.body.style.overflow='hidden';
}

function closeGroupModal(){
document.getElementById('groupModal').classList.remove('active');
document.body.style.overflow='';
}

loadUserInfo();
loadClubs();
</script>
</body>
</html>
