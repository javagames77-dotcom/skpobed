<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Director Dashboard</title>
<script src="i18n.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f5f5}
.header{background:#2196F3;color:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:1.5rem}
.user-info{display:flex;gap:1rem;align-items:center}
select{padding:0.5rem;border-radius:4px;border:1px solid #ddd}
.btn{padding:0.5rem 1rem;border:none;border-radius:4px;cursor:pointer}
.btn-logout{background:#fff;color:#2196F3}
.container{max-width:1200px;margin:2rem auto;padding:0 1rem}
.tabs{display:flex;gap:0.5rem;border-bottom:2px solid #ddd;margin-bottom:2rem}
.tab{padding:1rem 2rem;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:1rem}
.tab.active{border-bottom-color:#2196F3;color:#2196F3;font-weight:bold}
.content{display:none;background:#fff;padding:2rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.content.active{display:block}
.section-header{display:flex;justify-content:space-between;margin-bottom:1.5rem}
.btn-primary{background:#2196F3;color:#fff;padding:0.75rem 1.5rem}
table{width:100%;border-collapse:collapse}
th,td{padding:1rem;text-align:left;border-bottom:1px solid #ddd}
th{background:#f5f5f5;font-weight:600}
.btn-edit{background:#4CAF50;color:#fff;padding:0.5rem 1rem;margin:0 0.25rem}
.btn-delete{background:#f44336;color:#fff;padding:0.5rem 1rem;margin:0 0.25rem}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#fff;padding:2rem;border-radius:8px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;margin-bottom:1.5rem}
.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer}
.form-group{margin-bottom:1rem}
.form-group label{display:block;margin-bottom:0.5rem;font-weight:600}
.form-group input,.form-group select{width:100%;padding:0.75rem;border:1px solid #ddd;border-radius:4px}
.modal-footer{display:flex;gap:1rem;justify-content:flex-end;margin-top:1.5rem}
.btn-cancel{background:#9E9E9E;color:#fff;padding:0.75rem 1.5rem}
.schedule-editor{border:1px solid #ddd;padding:1rem;border-radius:4px;margin-top:0.5rem}
.schedule-day{background:#f9f9f9;padding:1rem;margin-bottom:0.5rem;border-radius:4px}
.schedule-header{display:flex;justify-content:space-between;margin-bottom:0.5rem}
.schedule-times{display:flex;gap:1rem}
.schedule-times input{flex:1}
</style>
</head>
<body>

<div class="header">
<h1>InSkill - Director</h1>
<div class="user-info">
<select id="langSelect">
<option value="ru">üá∑üá∫ –†–£</option>
<option value="uk">üá∫üá¶ –£–ö</option>
<option value="en">üá¨üáß EN</option>
</select>
<span id="userName"></span>
<button class="btn btn-logout" id="btnLogout">–í—ã—Ö–æ–¥</button>
</div>
</div>

<div class="container">
<div class="tabs">
<button class="tab active" data-tab="clubs">–ö–ª—É–±—ã</button>
<button class="tab" data-tab="groups">–ì—Ä—É–ø–ø—ã</button>
<button class="tab" data-tab="trainers">–¢—Ä–µ–Ω–µ—Ä—ã</button>
</div>

<div class="content active" id="clubs">
<div class="section-header">
<h2>–ö–ª—É–±—ã</h2>
<button class="btn btn-primary" id="btnAddClub">+ –î–æ–±–∞–≤–∏—Ç—å</button>
</div>
<div id="clubsLoading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<table id="clubsTable" style="display:none">
<thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ê–¥—Ä–µ—Å</th><th>–ì—Ä—É–ø–ø</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="clubsBody"></tbody>
</table>
</div>

<div class="content" id="groups">
<div class="section-header">
<h2>–ì—Ä—É–ø–ø—ã</h2>
<button class="btn btn-primary" id="btnAddGroup">+ –î–æ–±–∞–≤–∏—Ç—å</button>
</div>
<div id="groupsLoading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<table id="groupsTable" style="display:none">
<thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–ª—É–±</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="groupsBody"></tbody>
</table>
</div>

<div class="content" id="trainers">
<div class="section-header">
<h2>–¢—Ä–µ–Ω–µ—Ä—ã</h2>
<button class="btn btn-primary" id="btnAddTrainer">+ –î–æ–±–∞–≤–∏—Ç—å</button>
</div>
<div id="trainersLoading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<table id="trainersTable" style="display:none">
<thead><tr><th>–ò–º—è</th><th>Email</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
<tbody id="trainersBody"></tbody>
</table>
</div>
</div>

<!-- MODALS -->
<div class="modal" id="clubModal">
<div class="modal-content">
<div class="modal-header"><h3 id="clubModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–ª—É–±</h3><button class="modal-close">&times;</button></div>
<form id="clubForm">
<input type="hidden" id="clubId">
<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="clubName" required></div>
<div class="form-group"><label>–ê–¥—Ä–µ—Å</label><input type="text" id="clubAddress"></div>
<div class="modal-footer">
<button type="button" class="btn btn-cancel">–û—Ç–º–µ–Ω–∞</button>
<button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</form>
</div>
</div>

<div class="modal" id="groupModal">
<div class="modal-content">
<div class="modal-header"><h3 id="groupModalTitle">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</h3><button class="modal-close">&times;</button></div>
<form id="groupForm">
<input type="hidden" id="groupId">
<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="groupName" required></div>
<div class="form-group"><label>–ö–ª—É–± *</label><select id="groupClubId" required></select></div>
<div class="form-group">
<label>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</label>
<div class="schedule-editor">
<button type="button" class="btn btn-primary" id="btnAddDay">+ –î–µ–Ω—å</button>
<div id="scheduleDays"></div>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-cancel">–û—Ç–º–µ–Ω–∞</button>
<button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</form>
</div>
</div>

<div class="modal" id="trainerModal">
<div class="modal-content">
<div class="modal-header"><h3 id="trainerModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞</h3><button class="modal-close">&times;</button></div>
<form id="trainerForm">
<input type="hidden" id="trainerId">
<div class="form-group"><label>Email *</label><input type="email" id="trainerEmail" required></div>
<div class="form-group"><label>–ü–∞—Ä–æ–ª—å *</label><input type="password" id="trainerPassword" required></div>
<div class="form-group"><label>–ò–º—è *</label><input type="text" id="trainerFirstName" required></div>
<div class="form-group"><label>–§–∞–º–∏–ª–∏—è *</label><input type="text" id="trainerLastName" required></div>
<div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="trainerPhone"></div>
<div class="form-group"><label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="date" id="trainerBirthDate"></div>
<div class="form-group"><label>–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è</label><input type="text" id="trainerQualification"></div>
<div class="form-group"><label>–§–æ—Ç–æ (URL)</label><input type="url" id="trainerPhotoUrl"></div>
<div class="modal-footer">
<button type="button" class="btn btn-cancel">–û—Ç–º–µ–Ω–∞</button>
<button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</form>
</div>
</div>

<script>
const API='https://n8n.inskill.online/webhook/3a16e4f2-c8e4-42df-8c7f-01cbe2c31a49/api';
const AUTH_API='https://n8n.inskill.online/webhook/3a16e4f2-c8e4-42df-8c7f-01cbe2c31a49/auth';
let token=localStorage.getItem('token');
let user,clubs=[],groups=[],trainers=[],schedule=[];
if(!token)location.href='/';

function init(){
user=JSON.parse(localStorage.getItem('user')||'{}');
document.getElementById('userName').textContent=`${user.first_name||''} ${user.last_name||''}`;
initLangSelector();
applyTranslations();
loadClubs();
}

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
t.onclick=function(){
document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
document.querySelectorAll('.content').forEach(x=>x.classList.remove('active'));
this.classList.add('active');
document.getElementById(this.dataset.tab).classList.add('active');
const tab=this.dataset.tab;
if(tab==='groups'&&!groups.length)loadGroups();
if(tab==='trainers'&&!trainers.length)loadTrainers();
}
});

// Clubs
async function loadClubs(){
try{
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'clubs',action:'list'})});
const d=await r.json();
clubs=d.merged||d||[];
const sel=document.getElementById('groupClubId');
sel.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª—É–±</option>'+clubs.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
renderClubs();
}catch(e){console.error(e)}
}

function renderClubs(){
const tb=document.getElementById('clubsBody');
tb.innerHTML='';
clubs.forEach(c=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${c.name}</td><td>${c.address||'-'}</td><td>${c.groups_count||0}</td><td></td>`;
const btnE=document.createElement('button');
btnE.className='btn btn-edit';
btnE.textContent='‚úèÔ∏è';
btnE.onclick=()=>editClub(c.id);
const btnD=document.createElement('button');
btnD.className='btn btn-delete';
btnD.textContent='üóëÔ∏è';
btnD.onclick=()=>deleteClub(c.id);
tr.cells[3].append(btnE,btnD);
tb.appendChild(tr);
});
document.getElementById('clubsLoading').style.display='none';
document.getElementById('clubsTable').style.display='table';
}

window.editClub=function(id){
const c=clubs.find(x=>x.id===id);
if(!c)return;
document.getElementById('clubId').value=c.id;
document.getElementById('clubName').value=c.name;
document.getElementById('clubAddress').value=c.address||'';
document.getElementById('clubModal').classList.add('active');
}

window.deleteClub=async function(id){
if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—É–±?'))return;
try{
await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'clubs',action:'delete',data:{id}})});
loadClubs();
}catch(e){console.error(e)}
}

// Groups
async function loadGroups(){
try{
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'groups',action:'list'})});
const d=await r.json();
groups=d.merged||d||[];
renderGroups();
}catch(e){console.error(e)}
}

function renderGroups(){
const tb=document.getElementById('groupsBody');
tb.innerHTML='';
groups.forEach(g=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td><a href="/group-profile.html?id=${g.id}" style="color:#2196F3;font-weight:600">${g.name}</a></td><td>${g.club_name||'-'}</td><td></td>`;
const btnE=document.createElement('button');
btnE.className='btn btn-edit';
btnE.textContent='‚úèÔ∏è';
btnE.onclick=()=>editGroup(g.id);
const btnD=document.createElement('button');
btnD.className='btn btn-delete';
btnD.textContent='üóëÔ∏è';
btnD.onclick=()=>deleteGroup(g.id);
tr.cells[2].append(btnE,btnD);
tb.appendChild(tr);
});
document.getElementById('groupsLoading').style.display='none';
document.getElementById('groupsTable').style.display='table';
}

window.editGroup=function(id){
const g=groups.find(x=>x.id===id);
if(!g)return;
document.getElementById('groupId').value=g.id;
document.getElementById('groupName').value=g.name;
document.getElementById('groupClubId').value=g.club_id;
schedule=g.schedule?(typeof g.schedule==='string'?JSON.parse(g.schedule):g.schedule):[];
renderSchedule();
document.getElementById('groupModal').classList.add('active');
}

window.deleteGroup=async function(id){
if(!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?'))return;
try{
await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'groups',action:'delete',data:{id}})});
loadGroups();
}catch(e){console.error(e)}
}

function addDay(){
schedule.push({day:'Monday',time_start:'10:00',time_end:'12:00'});
renderSchedule();
}

function renderSchedule(){
const d=document.getElementById('scheduleDays');
d.innerHTML=schedule.map((s,i)=>`
<div class="schedule-day">
<div class="schedule-header">
<select onchange="schedule[${i}].day=this.value">
<option ${s.day==='Monday'?'selected':''}>Monday</option>
<option ${s.day==='Tuesday'?'selected':''}>Tuesday</option>
<option ${s.day==='Wednesday'?'selected':''}>Wednesday</option>
<option ${s.day==='Thursday'?'selected':''}>Thursday</option>
<option ${s.day==='Friday'?'selected':''}>Friday</option>
<option ${s.day==='Saturday'?'selected':''}>Saturday</option>
<option ${s.day==='Sunday'?'selected':''}>Sunday</option>
</select>
<button type="button" class="btn btn-delete" onclick="schedule.splice(${i},1);renderSchedule()">üóëÔ∏è</button>
</div>
<div class="schedule-times">
<input type="time" value="${s.time_start}" onchange="schedule[${i}].time_start=this.value">
<input type="time" value="${s.time_end}" onchange="schedule[${i}].time_end=this.value">
</div>
</div>`).join('');
}

// Trainers
async function loadTrainers(){
try{
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'users',action:'list',data:{role:'trainer'}})});
const d=await r.json();
trainers=d.merged||d||[];
renderTrainers();
}catch(e){console.error(e)}
}

function renderTrainers(){
const tb=document.getElementById('trainersBody');
tb.innerHTML='';
trainers.forEach(t=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td><a href="/trainer-profile.html?id=${t.id}" style="color:#2196F3;font-weight:600">${t.first_name||''} ${t.last_name||''}</a></td><td>${t.email}</td><td></td>`;
const btnE=document.createElement('button');
btnE.className='btn btn-edit';
btnE.textContent='‚úèÔ∏è';
btnE.onclick=()=>editTrainer(t.id);
const btnD=document.createElement('button');
btnD.className='btn btn-delete';
btnD.textContent='üóëÔ∏è';
btnD.onclick=()=>deleteTrainer(t.id);
tr.cells[2].append(btnE,btnD);
tb.appendChild(tr);
});
document.getElementById('trainersLoading').style.display='none';
document.getElementById('trainersTable').style.display='table';
}

window.editTrainer=function(id){
const t=trainers.find(x=>x.id===id);
if(!t)return;
document.getElementById('trainerId').value=t.id;
document.getElementById('trainerEmail').value=t.email;
document.getElementById('trainerPassword').value='';
document.getElementById('trainerPassword').required=false;
document.getElementById('trainerFirstName').value=t.first_name||'';
document.getElementById('trainerLastName').value=t.last_name||'';
document.getElementById('trainerPhone').value=t.phone||'';
document.getElementById('trainerBirthDate').value=t.birth_date||'';
document.getElementById('trainerQualification').value=t.qualification||'';
document.getElementById('trainerPhotoUrl').value=t.photo_url||'';
document.getElementById('trainerModal').classList.add('active');
}

window.deleteTrainer=async function(id){
if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞?'))return;
try{
await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'users',action:'delete',data:{id}})});
loadTrainers();
}catch(e){console.error(e)}
}

// Event handlers
document.getElementById('btnLogout').onclick=()=>{localStorage.clear();location.href='/'};
document.getElementById('btnAddClub').onclick=()=>{document.getElementById('clubForm').reset();document.getElementById('clubId').value='';document.getElementById('clubModal').classList.add('active')};
document.getElementById('btnAddGroup').onclick=()=>{document.getElementById('groupForm').reset();document.getElementById('groupId').value='';schedule=[];renderSchedule();document.getElementById('groupModal').classList.add('active')};
document.getElementById('btnAddTrainer').onclick=()=>{document.getElementById('trainerForm').reset();document.getElementById('trainerId').value='';document.getElementById('trainerPassword').required=true;document.getElementById('trainerModal').classList.add('active')};
document.getElementById('btnAddDay').onclick=addDay;

document.getElementById('clubForm').onsubmit=async e=>{
e.preventDefault();
const id=document.getElementById('clubId').value;
const data={name:document.getElementById('clubName').value,address:document.getElementById('clubAddress').value,director_id:user.id};
if(id)data.id=parseInt(id);
try{
await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'clubs',action:id?'update':'create',data})});
document.getElementById('clubModal').classList.remove('active');
loadClubs();
}catch(e){console.error(e)}
};

document.getElementById('groupForm').onsubmit=async e=>{
e.preventDefault();
const id=document.getElementById('groupId').value;
const data={name:document.getElementById('groupName').value,club_id:parseInt(document.getElementById('groupClubId').value),schedule:JSON.stringify(schedule)};
if(id)data.id=parseInt(id);
try{
await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'groups',action:id?'update':'create',data})});
document.getElementById('groupModal').classList.remove('active');
loadGroups();
}catch(e){console.error(e)}
};

document.getElementById('trainerForm').onsubmit=async e=>{
e.preventDefault();
const id=document.getElementById('trainerId').value;
const data={email:document.getElementById('trainerEmail').value,first_name:document.getElementById('trainerFirstName').value,last_name:document.getElementById('trainerLastName').value,phone:document.getElementById('trainerPhone').value,birth_date:document.getElementById('trainerBirthDate').value,qualification:document.getElementById('trainerQualification').value,photo_url:document.getElementById('trainerPhotoUrl').value,role:'trainer'};
try{
if(id){
data.id=parseInt(id);
await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,resource:'users',action:'update',data})});
}else{
data.password=document.getElementById('trainerPassword').value;
await fetch(AUTH_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'register',...data})});
}
document.getElementById('trainerModal').classList.remove('active');
loadTrainers();
}catch(e){console.error(e)}
};

document.querySelectorAll('.modal-close, .btn-cancel').forEach(b=>b.onclick=function(){this.closest('.modal').classList.remove('active')});
document.getElementById('langSelect').onchange=function(){setLang(this.value);applyTranslations()};

function applyTranslations(){
document.getElementById('btnLogout').textContent=t('logout');
}

init();
</script>
</body>
</html>
