<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º–∏ - BJJ Club!</title>
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    background: #fff;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
h1 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
    font-size: 2rem;
}
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat-card {
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color: #fff;
    padding: 15px;
    border-radius: 15px;
    text-align: center;
}
.stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
.stat-label { font-size: 0.9rem; opacity: 0.9; }

.search-box {
    max-width: 100%;
    box-sizing: border-box;
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    margin-bottom: 15px;
}
.search-box:focus { outline:none; border-color:#667eea; }

.table-wrapper { width: 100%; overflow-x: auto; }
table { width:100%; border-collapse: collapse; min-width:400px; border:0; }
thead { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; }
th, td { padding:10px; font-size:0.9rem; text-align:left; }
tbody tr { border-bottom:1px solid #eee; transition: background 0.2s; }
tbody tr:hover { background:#f8f9ff; }
.photo-thumb { width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #667eea; }
.btn { padding:5px 10px; border:none; border-radius:6px; cursor:pointer; font-size:0.8rem; font-weight:600; margin:0 2px; transition:0.3s; }
.btn-edit { background:#4caf50; color:#fff; }
.btn-edit:hover { background:#45a049; transform:translateY(-1px); }
.btn-delete { background:#f44336; color:#fff; }
.btn-delete:hover { background:#da190b; transform:translateY(-1px); }

.modal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    z-index:1000;
    align-items:center;
    justify-content:center;
    padding: 10px;
}
.modal.active { display:flex; }
.modal-content {
    background:#fff;
    border-radius:15px;
    width:100%;
    max-width:400px;
    max-height:90vh;
    overflow-y:auto;
    padding:20px;
    display:flex;
    flex-direction: column;
}
.modal-header { font-size:1.2rem; font-weight:bold; margin-bottom:15px; color:#333; text-align:center; }
.form-group { margin-bottom:15px; display:flex; flex-direction: column; }
.form-group label { margin-bottom:5px; font-weight:600; color:#555; }
.form-group input { padding:10px; border:2px solid #e0e0e0; border-radius:6px; font-size:16px; width:100%; box-sizing:border-box; -webkit-text-size-adjust:100%; }
.form-group input:focus { outline:none; border-color:#667eea; }
.modal-buttons { display:flex; flex-direction: column; gap:10px; margin-top:10px; }
.btn-save { width:100%; padding:12px; background:#667eea; color:#fff; font-size:1rem; border-radius:6px; }
.btn-save:hover { background:#5568d3; }
.btn-cancel { width:100%; padding:12px; background:#999; color:#fff; font-size:1rem; border-radius:6px; }
.btn-cancel:hover { background:#777; }
.save-message { display:none; text-align:center; padding:10px; background:#e0ffe0; color:#1b5e20; margin-bottom:10px; border-radius:8px; font-weight:bold; }
.save-message button { margin-top:10px; padding:8px 16px; font-size:1rem; border:none; border-radius:6px; background:#4caf50; color:#fff; cursor:pointer; }

.error { background:#ffebee; color:#c62828; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; }

@media (max-width:500px){
    th, td { font-size:0.75rem; padding:5px; }
    .photo-thumb { width:30px; height:30px; }
    .btn { font-size:0.7rem; padding:3px 6px; }
    h1 { font-size:1.5rem; }
    .form-group input { font-size:16px; } /* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∑—É–º–∏–ª–æ—Å—å */
}
</style>
</head>
<body>
<div class="container">
    <h1>ü•ã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º–∏ - BJJ Club</h1>
    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="totalChildren">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –¥–µ—Ç–µ–π</div>
        </div>
    </div>
    <input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
    <div id="errorMessage" class="error" style="display:none;"></div>
    <div class="table-wrapper"><div id="tableContainer"></div></div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–±–µ–Ω–∫–∞</div>
        <div class="save-message" id="saveMessage">
            ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!
            <button onclick="closeSaveMessage()">–ì–æ—Ç–æ–≤–æ</button>
        </div>
        <form id="editForm">
           <table border="0">
               <tr><td><div class="form-group"><label>–ò–º—è</label></div></td></tr>
               <tr><td><input type="text" id="editName" required></td></tr>
               <tr><td><div class="form-group"><label>URL —Ñ–æ—Ç–æ</label></div></td></tr>
               <tr><td><input type="text" id="editPhoto"></td></tr>
               <tr><td><button type="submit" class="btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td></tr>
               <tr><td><button type="button" class="btn-cancel" onclick="closeEditModal()">‚ùå –û—Ç–º–µ–Ω–∞</button></td></tr>
           </table>
        </form>
    </div>
</div>

<script>
const API_BASE = 'https://primary-production-4b93e.up.railway.app/webhook';
const API_GET = `${API_BASE}/api/children`;
const API_UPDATE = `${API_BASE}/ea619676-d586-4606-8eef-be9ba9c3193c`;
const API_DELETE = `${API_BASE}/api/children/delete`;

let children = [];
let currentEditChild = null;

async function loadChildren() {
    try {
        document.getElementById('tableContainer').innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        const res = await fetch(API_GET);
        const data = await res.json();
        if(data.success){ children = data.data; updateStats(); renderTable(); } 
        else showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    } catch(e){ showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); console.error(e); }
}

function updateStats(){ document.getElementById('totalChildren').textContent = children.length; }

function renderTable(filter=''){
    const filtered = children.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
    const html = `<table>
        <thead><tr><th>–§–æ—Ç–æ</th><th>–ò–º—è</th><th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody>
        ${filtered.map(c=>`
        <tr>
            <td>${c.photo_url?`<img src="${c.photo_url}" class="photo-thumb" alt="${c.name}">`:'<div class="photo-thumb" style="background:#ddd;"></div>'}</td>
            <td><strong>${c.name}</strong></td>
            <td>${c.created_at?new Date(c.created_at).toLocaleDateString('ru-RU'):'-'}</td>
            <td><button class="btn btn-edit" onclick="editChild('${c.name}')">‚úèÔ∏è</button></td>
        </tr>`).join('')}
        </tbody></table>`;
    document.getElementById('tableContainer').innerHTML = html;
}

document.getElementById('searchInput').addEventListener('input', e=>renderTable(e.target.value));

function editChild(name){
    currentEditChild = children.find(c=>c.name===name);
    if(!currentEditChild) return;
    document.getElementById('editName').value = currentEditChild.name;
    document.getElementById('editPhoto').value = currentEditChild.photo_url||'';
    if(!currentEditChild.face_token) currentEditChild.face_token = crypto.randomUUID();
    document.getElementById('saveMessage').style.display='none';
    document.getElementById('editForm').style.display='flex';
    document.getElementById('editModal').classList.add('active');
}

function closeEditModal(){ document.getElementById('editModal').classList.remove('active'); currentEditChild=null; }

function closeSaveMessage(){
    document.getElementById('saveMessage').style.display='none';
    closeEditModal();
    loadChildren();
}

document.getElementById('editForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const newName = document.getElementById('editName').value;
    const newPhoto = document.getElementById('editPhoto').value;
    try{
        const formData = new FormData();
        formData.append('name', newName);
        formData.append('photo_url', newPhoto);
        formData.append('face_token', currentEditChild.face_token);
        const res = await fetch(API_UPDATE, { method:'POST', body:formData });
        const data = await res.json();
        if(data.success){
            document.getElementById('editForm').style.display='none';
            document.getElementById('saveMessage').style.display='block';
        } else showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    } catch(err){ showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); console.error(err); }
});

async function deleteChild(name){
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) return;
    try{
        const res = await fetch(API_DELETE,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name})});
        const data = await res.json();
        if(data.success){ loadChildren(); } else showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    } catch(err){ showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); console.error(err); }
}

function showError(msg){
    const el = document.getElementById('errorMessage');
    el.textContent = msg; el.style.display='block';
    setTimeout(()=>{ el.style.display='none'; },5000);
}

document.getElementById('editModal').addEventListener('click', e=>{
    if(e.target.id==='editModal') closeEditModal();
});

loadChildren();
</script>
</body>
</html>
