<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BJJ Club - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º–∏</title>
<style>
* {margin:0; padding:0; box-sizing:border-box;}
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    padding:10px;
}
.container {
    width:95%;
    max-width:1200px;
    margin:0 auto;
    background:white;
    border-radius:15px;
    padding:20px;
    box-shadow:0 15px 50px rgba(0,0,0,0.3);
}
h1 {
    text-align:center;
    margin-bottom:20px;
    font-size:2rem;
    color:#333;
}
.stats {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    gap:15px;
    margin-bottom:20px;
}
.stat-card {
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:white;
    padding:15px;
    border-radius:10px;
    text-align:center;
}
.stat-number { font-size:1.5rem; font-weight:bold; }
.stat-label { font-size:0.85rem; opacity:0.9; }

.search-box {
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1.5px solid #ccc;
    margin-bottom:15px;
    font-size:1rem;
}
.search-box:focus { border-color:#667eea; outline:none; }

table { width:100%; border-collapse:collapse; font-size:0.9rem; overflow-x:auto; }
thead { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }
th,td { padding:10px; text-align:left; word-break:break-word; }
tbody tr:hover { background:#f0f4ff; }

.photo-thumb { width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #667eea; }

.btn {
    padding:10px; font-size:0.9rem;
    border:none; border-radius:6px;
    cursor:pointer; margin:2px;
    min-height:42px;
    display:inline-flex; align-items:center; justify-content:center;
    font-weight:600;
    transition:0.2s;
}

/* –¶–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞ –∫–Ω–æ–ø–æ–∫ */
.btn-edit { background:#4CAF50; color:white; }
.btn-edit:hover { background:#43a047; }
.btn-delete { background:#f44336; color:white; }
.btn-delete:hover { background:#e53935; }
.btn-save { background:#667eea; color:white; }
.btn-save:hover { background:#5568d3; }
.btn-cancel { background:#999; color:white; }
.btn-cancel:hover { background:#777; }

.modal, .notification {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center; padding:10px;
}
.modal.active, .notification.active { display:flex; }

.modal-content, .notification-content {
    background:white; border-radius:15px; padding:20px; max-width:450px; width:90%; max-height:90vh; overflow-y:auto;
}

.form-group { margin-bottom:15px; }
.form-group label { display:block; margin-bottom:5px; font-weight:600; }
.form-group input { width:100%; padding:12px; font-size:1rem; border-radius:6px; border:1.5px solid #ccc; }
.form-group input:focus { border-color:#667eea; outline:none; }

.modal-buttons, .notification-buttons { display:flex; gap:10px; margin-top:15px; }

.notification-content p { margin-bottom:15px; font-size:1rem; text-align:center; }

.error { background:#ffebee; color:#c62828; padding:10px; border-radius:8px; margin-bottom:10px; text-align:center; }
.loading { text-align:center; padding:20px; color:#555; }

@media(max-width:600px){
    h1{font-size:1.5rem;}
    .stat-number{font-size:1.2rem;}
    .stat-label{font-size:0.7rem;}
    .btn{font-size:0.8rem; padding:8px; min-height:38px;}
    .photo-thumb{width:30px; height:30px;}
}
</style>
</head>
<body>
<div class="container">
<h1>ü•ã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º–∏ - BJJ Club</h1>
<div class="stats">
    <div class="stat-card">
        <div class="stat-number" id="totalChildren">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ –¥–µ—Ç–µ–π</div>
    </div>
</div>
<input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
<div id="errorMessage" class="error" style="display:none;"></div>
<div id="tableContainer"></div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–±–µ–Ω–∫–∞</div>
        <form id="editForm">
            <div class="form-group">
                <label>–ò–º—è</label>
                <input type="text" id="editName" required>
            </div>
            <div class="form-group">
                <label>URL —Ñ–æ—Ç–æ</label>
                <input type="text" id="editPhoto">
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn btn-cancel" onclick="closeEditModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<!-- Notification Modal -->
<div id="notification" class="notification">
    <div class="notification-content">
        <p id="notificationText">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</p>
        <div class="notification-buttons">
            <button class="btn btn-save" onclick="closeNotification()">–ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<script>
const API_BASE = 'https://primary-production-4b93e.up.railway.app/webhook';
const API_GET = `${API_BASE}/api/children`;
const API_UPDATE = `${API_BASE}/ea619676-d586-4606-8eef-be9ba9c3193c`;
const API_DELETE = `${API_BASE}/api/children/delete`;

let children=[], currentEditChild=null;

async function loadChildren(){
    document.getElementById('tableContainer').innerHTML='<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try{
        const res=await fetch(API_GET);
        const data=await res.json();
        if(data.success){ children=data.data; updateStats(); renderTable(); }
        else showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    }catch(e){ showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); console.error(e);}
}

function updateStats(){ document.getElementById('totalChildren').textContent=children.length; }

function renderTable(filter=''){
    const filtered=children.filter(c=>c.name.toLowerCase().includes(filter.toLowerCase()));
    let html='<table><thead><tr><th>–§–æ—Ç–æ</th><th>–ò–º—è</th><th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
    filtered.forEach(child=>{
        html+=`<tr>
<td>${child.photo_url?`<img src="${child.photo_url}" class="photo-thumb">`:'<div class="photo-thumb" style="background:#ddd;"></div>'}</td>
<td><strong>${child.name}</strong></td>
<td>${child.created_at?new Date(child.created_at).toLocaleDateString('ru-RU'):'-'}</td>
<td>
<button class="btn btn-edit" onclick="editChild('${child.name}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="btn btn-delete" onclick="deleteChild('${child.name}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
</td></tr>`});
    html+='</tbody></table>';
    document.getElementById('tableContainer').innerHTML=html;
}

document.getElementById('searchInput').addEventListener('input',e=>renderTable(e.target.value));

function editChild(name){
    currentEditChild=children.find(c=>c.name===name);
    if(!currentEditChild) return;
    document.getElementById('editName').value=currentEditChild.name;
    document.getElementById('editPhoto').value=currentEditChild.photo_url||'';
    if(!currentEditChild.face_token) currentEditChild.face_token=crypto.randomUUID();
    document.getElementById('editModal').classList.add('active');
}
function closeEditModal(){ document.getElementById('editModal').classList.remove('active'); currentEditChild=null; }

document.getElementById('editForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const newName=document.getElementById('editName').value;
    const newPhoto=document.getElementById('editPhoto').value;
    try{
        const formData=new FormData();
        formData.append('name',newName);
        formData.append('photo_url',newPhoto);
        formData.append('face_token',currentEditChild.face_token);
        const res=await fetch(API_UPDATE,{method:'POST',body:formData});
        const data=await res.json();
        if(data.success){ closeEditModal(); loadChildren(); showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
        else showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }catch(e){ showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); console.error(e);}
});

async function deleteChild(name){
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) return;
    try{
        const res=await fetch(API_DELETE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
        const data=await res.json();
        if(data.success){ loadChildren(); showNotification('‚úÖ –£–¥–∞–ª–µ–Ω–æ'); }
        else showNotification('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }catch(e){ showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'); console.error(e);}
}

function showError(msg){ const el=document.getElementById('errorMessage'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',5000); }
document.getElementById('editModal').addEventListener('click',e=>{ if(e.target.id==='editModal') closeEditModal(); });
function showNotification(msg){ document.getElementById('notificationText').textContent=msg; document.getElementById('notification').classList.add('active'); }
function closeNotification(){ document.getElementById('notification').classList.remove('active'); }

loadChildren();
</script>
</body>
</html>
